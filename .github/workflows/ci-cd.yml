name: Stock Forecast CI/CD Pipeline

on:
  push:
    branches: [main]

jobs:
  stock-forecast:
    runs-on: ubuntu-latest
    env:
      MLFLOW_TRACKING_URI: http://localhost:5000 

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Setup Python 3.10
        uses: actions/setup-python@v4
        with:
          python-version: 3.10.12

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Extract Stock Data
        run: |
          python -c "from src.extract import fetch_data; fetch_data(['BMRI','BBRI','BBCA'])"

      - name: Train Models (includes preprocessing & evaluation)
        run: |
          python -c "from src.train import train_best_model; [train_best_model(ticker) for ticker in ['BMRI','BBRI','BBCA']]"

      - name: Smoke Test Prediction
        run: |
          python -c "
from src.predict import forecast_next_days
tickers = ['BMRI', 'BBRI', 'BBCA']
for tkr in tickers:
    preds = forecast_next_days(tkr, days=5)
    print(f'Predictions for {tkr}:', preds.flatten())
"

      - name: Deploy Streamlit App (Placeholder)
        run: |
          echo "Deployment step here"
